<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sns.db.MatchMapper">

	<select id="filter_basic" parameterType="sns.model.MatchDTO" resultType="sns.model.MatchDTO">
		select member_id, name, dis, gender, rating_person 
		from basic_info 
		where gender in (#{gender}) 
			and rating_person >= #{rating} 
			and member_id in (select member_id from hope_area where area = #{area}) 
			and member_id in (select member_id from interest where #{interest} is not null)
	</select>
	
	<select id="filter_group" parameterType="sns.model.MatchDTO" resultType="sns.model.MatchDTO">
		select group_id, group_info, rating_group
		from p_group 
		where rating_group >= #{rating} 
			and group_id in (select group_id from hope_area where area = #{area}) 
			and group_id in (select group_id from interest where #{interest} is not null)
	</select>
	 
	<insert id="ptp_match_req" parameterType="sns.model.MatchDTO">
		insert into request(member_id, req_member_id, moim_ptp) values(#{id}, #{req_id}, 1)
	</insert>
	
	<insert id="ptg_match_req" parameterType="sns.model.MatchDTO">
		insert into request(group_id, req_member_id, group_ptg) values(#{id}, #{req_id}, 1)
	</insert>
	
	<select id="req_ptp" resultType="sns.model.MatchDTO">
		select member_id, name, dis, gender, rating_person 
		from basic_info 
		where member_id in (select req_member_id from request where member_id = #{user_id})
			and member_id in (select req_member_id from request where moim_ptp is not null)
	</select>
	
	<select id="req_mtp" resultType="sns.model.MatchDTO">
		select req_moim_id 
		from request
		where req_moim_id in (select req_moim_id from request where member_id = #{user_id})
			and req_moim_id in (select req_moim_id from request where moim_mtp is not null)
	</select>
	
	<select id="req_gtp" resultType="sns.model.MatchDTO">
		select group_id, group_info, rating_group
		from p_group 
		where group_id in (select req_group_id from request where member_id=#{user_id})
			and group_id in (select req_group_id from request where group_gtp is not null)
	</select>
	
	<insert id="new_moim" parameterType="sns.model.MatchDTO">
		insert into moim_list values(#{id}, #{req_id}, 1)
	</insert>
	
</mapper>